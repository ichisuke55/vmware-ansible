---
# tasks file for prepare-custom-esxi-iso

- name: Create temp dir
  ansible.builtin.file:
    path: "{{ build.temp_folder }}"
    state: directory

- name: Mount ESXi iso
  ansible.posix.mount:
    path: "{{ build.mount_point }}"
    src: "{{ build.iso_directory }}/{{ build.iso_file }}"
    fstype: iso9660
    opts: ro,noauto
    state: mounted
  become: yes

        #  - name: Copy boot.cfg from ESXi iso
        #    ansible.builtin.copy:
        #      src: "{{ build.mount_point }}/boot.cfg"
        #      dest: "{{ build.temp_folder }}/{{ build.esxi_installder }}/"
        #      mode: "666"
        #
        #  - name: Edit boot.cfg
        #    ansible.builtin.replace:
        #      dest: "{{ build.temp_folder }}/{{ build.esxi_installer }}/boot.cfg"
        #      regexp: 'kernelopt=.*'
        #      replace: 'kernelopt=ks=cdrom:/KS.CFG'
        #
        #  - name: Create directory for each nested ESXi host
        #    ansible.builtin.file:
        #      path: "{{ build.temp_folder }}/{{ item.value.vm_name }}"
        #      state: directory
        #    loop: "{{ nested_esxi.host | dict2items }}"

#  - name: Create kickstart file for each nested ESXi host
#    ansible.builtin.template:
#      src: "{{ temp_folder }}/"

